{"version":3,"sources":["KeyboardManager.tsx"],"names":["React","TextInput","Keyboard","KeyboardManager","Component","undefined","keyboardTimeout","clearTimeout","props","enabled","clearKeyboardTimeout","input","State","currentlyFocusedInput","currentlyFocusedField","blurTextInput","previouslyFocusedTextInput","startTimestamp","Date","now","force","dismiss","setTimeout","focusTextInput","componentWillUnmount","render","children","onPageChangeStart","handlePageChangeStart","onPageChangeConfirm","handlePageChangeConfirm","onPageChangeCancel","handlePageChangeCancel"],"mappings":";;AAAA,OAAO,KAAKA,KAAZ,MAAuB,OAAvB;AACA,SAASC,SAAT,EAAoBC,QAApB,QAAmD,cAAnD;AAaA,eAAe,MAAMC,eAAN,SAA8BH,KAAK,CAACI,SAApC,CAAqD;AAAA;AAAA;;AAAA,wDAOnBC,SAPmB;;AAAA,4CAQjC,CARiC;;AAAA;;AAAA,kDAWnC,MAAM;AACnC,UAAI,KAAKC,eAAL,KAAyBD,SAA7B,EAAwC;AACtCE,QAAAA,YAAY,CAAC,KAAKD,eAAN,CAAZ;AACA,aAAKA,eAAL,GAAuBD,SAAvB;AACD;AACF,KAhBiE;;AAAA,mDAkBlC,MAAM;AACpC,UAAI,CAAC,KAAKG,KAAL,CAAWC,OAAhB,EAAyB;AACvB;AACD;;AAED,WAAKC,oBAAL,GALoC,CAOpC;;AACA,YAAMC,KAAe,GAAGV,SAAS,CAACW,KAAV,CAAgBC,qBAAhB,GACpBZ,SAAS,CAACW,KAAV,CAAgBC,qBAAhB,EADoB,GAEpBZ,SAAS,CAACW,KAAV,CAAgBE,qBAAhB,EAFJ,CARoC,CAYpC;;AACAb,MAAAA,SAAS,CAACW,KAAV,CAAgBG,aAAhB,CAA8BJ,KAA9B,EAboC,CAepC;;AACA,WAAKK,0BAAL,GAAkCL,KAAlC,CAhBoC,CAkBpC;;AACA,WAAKM,cAAL,GAAsBC,IAAI,CAACC,GAAL,EAAtB;AACD,KAtCiE;;AAAA,qDAwC/BC,KAAD,IAAoB;AACpD,UAAI,CAAC,KAAKZ,KAAL,CAAWC,OAAhB,EAAyB;AACvB;AACD;;AAED,WAAKC,oBAAL;;AAEA,UAAIU,KAAJ,EAAW;AACT;AACA;AACA;AACAlB,QAAAA,QAAQ,CAACmB,OAAT;AACD,OALD,MAKO;AACL,cAAMV,KAAK,GAAG,KAAKK,0BAAnB;;AAEA,YAAIL,KAAJ,EAAW;AACT;AACA;AACAV,UAAAA,SAAS,CAACW,KAAV,CAAgBG,aAAhB,CAA8BJ,KAA9B;AACD;AACF,OApBmD,CAsBpD;;;AACA,WAAKK,0BAAL,GAAkCX,SAAlC;AACD,KAhEiE;;AAAA,oDAkEjC,MAAM;AACrC,UAAI,CAAC,KAAKG,KAAL,CAAWC,OAAhB,EAAyB;AACvB;AACD;;AAED,WAAKC,oBAAL,GALqC,CAOrC;;AACA,YAAMC,KAAK,GAAG,KAAKK,0BAAnB;;AAEA,UAAIL,KAAJ,EAAW;AACT;AAEA;AACA;AACA;AACA;AACA;AACA,YAAIO,IAAI,CAACC,GAAL,KAAa,KAAKF,cAAlB,GAAmC,GAAvC,EAA4C;AAC1C,eAAKX,eAAL,GAAuBgB,UAAU,CAAC,MAAM;AACtCrB,YAAAA,SAAS,CAACW,KAAV,CAAgBW,cAAhB,CAA+BZ,KAA/B;AACA,iBAAKK,0BAAL,GAAkCX,SAAlC;AACD,WAHgC,EAG9B,GAH8B,CAAjC;AAID,SALD,MAKO;AACLJ,UAAAA,SAAS,CAACW,KAAV,CAAgBW,cAAhB,CAA+BZ,KAA/B;AACA,eAAKK,0BAAL,GAAkCX,SAAlC;AACD;AACF;AACF,KA9FiE;AAAA;;AAClEmB,EAAAA,oBAAoB,GAAG;AACrB,SAAKd,oBAAL;AACD,GAHiE,CAKlE;AACA;;;AA0FAe,EAAAA,MAAM,GAAG;AACP,WAAO,KAAKjB,KAAL,CAAWkB,QAAX,CAAoB;AACzBC,MAAAA,iBAAiB,EAAE,KAAKC,qBADC;AAEzBC,MAAAA,mBAAmB,EAAE,KAAKC,uBAFD;AAGzBC,MAAAA,kBAAkB,EAAE,KAAKC;AAHA,KAApB,CAAP;AAKD;;AAtGiE","sourcesContent":["import * as React from 'react';\r\nimport { TextInput, Keyboard, HostComponent } from 'react-native';\r\n\r\ntype Props = {\r\n  enabled: boolean;\r\n  children: (props: {\r\n    onPageChangeStart: () => void;\r\n    onPageChangeConfirm: (force: boolean) => void;\r\n    onPageChangeCancel: () => void;\r\n  }) => React.ReactNode;\r\n};\r\n\r\ntype InputRef = React.ElementRef<HostComponent<unknown>> | undefined;\r\n\r\nexport default class KeyboardManager extends React.Component<Props> {\r\n  componentWillUnmount() {\r\n    this.clearKeyboardTimeout();\r\n  }\r\n\r\n  // Numeric id of the previously focused text input\r\n  // When a gesture didn't change the tab, we can restore the focused input with this\r\n  private previouslyFocusedTextInput: InputRef = undefined;\r\n  private startTimestamp: number = 0;\r\n  private keyboardTimeout: any;\r\n\r\n  private clearKeyboardTimeout = () => {\r\n    if (this.keyboardTimeout !== undefined) {\r\n      clearTimeout(this.keyboardTimeout);\r\n      this.keyboardTimeout = undefined;\r\n    }\r\n  };\r\n\r\n  private handlePageChangeStart = () => {\r\n    if (!this.props.enabled) {\r\n      return;\r\n    }\r\n\r\n    this.clearKeyboardTimeout();\r\n\r\n    // @ts-expect-error: blurTextInput accepts both number and ref, but types say only ref\r\n    const input: InputRef = TextInput.State.currentlyFocusedInput\r\n      ? TextInput.State.currentlyFocusedInput()\r\n      : TextInput.State.currentlyFocusedField();\r\n\r\n    // When a page change begins, blur the currently focused input\r\n    TextInput.State.blurTextInput(input);\r\n\r\n    // Store the id of this input so we can refocus it if change was cancelled\r\n    this.previouslyFocusedTextInput = input;\r\n\r\n    // Store timestamp for touch start\r\n    this.startTimestamp = Date.now();\r\n  };\r\n\r\n  private handlePageChangeConfirm = (force: boolean) => {\r\n    if (!this.props.enabled) {\r\n      return;\r\n    }\r\n\r\n    this.clearKeyboardTimeout();\r\n\r\n    if (force) {\r\n      // Always dismiss input, even if we don't have a ref to it\r\n      // We might not have the ref if onPageChangeStart was never called\r\n      // This can happen if page change was not from a gesture\r\n      Keyboard.dismiss();\r\n    } else {\r\n      const input = this.previouslyFocusedTextInput;\r\n\r\n      if (input) {\r\n        // Dismiss the keyboard only if an input was a focused before\r\n        // This makes sure we don't dismiss input on going back and focusing an input\r\n        TextInput.State.blurTextInput(input);\r\n      }\r\n    }\r\n\r\n    // Cleanup the ID on successful page change\r\n    this.previouslyFocusedTextInput = undefined;\r\n  };\r\n\r\n  private handlePageChangeCancel = () => {\r\n    if (!this.props.enabled) {\r\n      return;\r\n    }\r\n\r\n    this.clearKeyboardTimeout();\r\n\r\n    // The page didn't change, we should restore the focus of text input\r\n    const input = this.previouslyFocusedTextInput;\r\n\r\n    if (input) {\r\n      // If the interaction was super short we should make sure keyboard won't hide again.\r\n\r\n      // Too fast input refocus will result only in keyboard flashing on screen and hiding right away.\r\n      // During first ~100ms keyboard will be dismissed no matter what,\r\n      // so we have to make sure it won't interrupt input refocus logic.\r\n      // That's why when the interaction is shorter than 100ms we add delay so it won't hide once again.\r\n      // Subtracting timestamps makes us sure the delay is executed only when needed.\r\n      if (Date.now() - this.startTimestamp < 100) {\r\n        this.keyboardTimeout = setTimeout(() => {\r\n          TextInput.State.focusTextInput(input);\r\n          this.previouslyFocusedTextInput = undefined;\r\n        }, 100);\r\n      } else {\r\n        TextInput.State.focusTextInput(input);\r\n        this.previouslyFocusedTextInput = undefined;\r\n      }\r\n    }\r\n  };\r\n\r\n  render() {\r\n    return this.props.children({\r\n      onPageChangeStart: this.handlePageChangeStart,\r\n      onPageChangeConfirm: this.handlePageChangeConfirm,\r\n      onPageChangeCancel: this.handlePageChangeCancel,\r\n    });\r\n  }\r\n}\r\n"]}